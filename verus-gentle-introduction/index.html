<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <title>A gentle introduction to checking code correctness in Verus</title>
    <meta name="description" content="">

    <link rel="stylesheet" href="https://verus-lang.github.io/blog/main.css">

    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://verus-lang.github.io/blog/atom.xml">
    

    
    
</head>
<body>

  <div class="watermark">
    <div class="watermark-text">DRAFT</div>
  </div>

  <div class="flex-container">
  <!--<a class="skip-main" href="#main">Skip to content</a>-->
    <div class="left-float">
      <div class="left-header">
      <h1 class="site-header">
          <a href="https:&#x2F;&#x2F;verus-lang.github.io&#x2F;blog">Verus blog</a>
      </h1>
      <p style="text-align: justify;">Verus is a tool for verifying the correctness of code written in Rust. Developers write specifications of what their code should do, and Verus statically checks that the executable Rust code will always satisfy the specifications for all possible executions of the code.</p>
      <p style="font-weight: bold; font-size: 100%">Verus is open-source at <a href="https://github.com/verus-lang/verus">github.com/verus-lang/verus</a></p>
      </div>
      
    </div>
    <div class="container">
        <header> 
            <!--<nav>
                
                
                
                <a  href="https:&#x2F;&#x2F;github.com&#x2F;verus-lang&#x2F;verus">Verus</a>
                
                
            </nav>-->
        </header>
        <main id="main" tabindex="-1">
            

<article class="post">
    <header>
        <h1>A gentle introduction to checking code correctness in Verus</h1>
    </header>
    <div class="content">
        <style type="text/css">
.note {
    font-size: 80%;
    line-height: 1em;
}
</style>
<p>I'm going to talk about the tool we've been building, called Verus, which is a tool to verify Rust, and specifically to verify Rust code in the domain of system software: operating systems, file systems, things like that.</p>
<span id="continue-reading"></span>
<p><i class="note">This post is based, in part, on the talk <a href="https://www.youtube.com/watch?v=ZZTk-zS4ZCY">&quot;Verified Rust for low-level systems code - Rust ZÃ¼risee June 2023&quot;</a>.</i></p>
<h3 id="checking-code-correctness-with-testing">Checking code correctness with testing</h3>
<p>Instead of trying to explain what verification is, I'm just going to jump into an example. You're writing a very simple max function here. What you might do is try to write a test for it. </p>
<pre data-linenos data-lang="rust" style="background-color:#2b2c2f;color:#cccece;" class="language-rust "><code class="language-rust" data-lang="rust"><table><tbody><tr><td>1</td><td><span style="color:#c594c5;">fn </span><span style="color:#6699cc;">max</span><span style="color:#5fb3b3;">(</span><span style="color:#f99157;">a</span><span style="color:#5fb3b3;">: </span><span style="color:#c594c5;">u64</span><span>, </span><span style="color:#f99157;">b</span><span style="color:#5fb3b3;">: </span><span style="color:#c594c5;">u64</span><span style="color:#5fb3b3;">) -&gt; </span><span style="color:#c594c5;">u64 </span><span style="color:#5fb3b3;">{
</span></td></tr><tr><td>2</td><td><span>    </span><span style="color:#c594c5;">if</span><span> a </span><span style="color:#5fb3b3;">&gt;=</span><span> b </span><span style="color:#5fb3b3;">{</span><span> b </span><span style="color:#5fb3b3;">} </span><span style="color:#c594c5;">else </span><span style="color:#5fb3b3;">{</span><span> a </span><span style="color:#5fb3b3;">}
</span></td></tr><tr><td>3</td><td><span style="color:#5fb3b3;">}
</span></td></tr><tr><td>4</td><td><span>
</span></td></tr><tr><td>5</td><td><span style="color:#c594c5;">fn </span><span style="color:#6699cc;">max_test_1</span><span style="color:#5fb3b3;">() {
</span></td></tr><tr><td>6</td><td><span>    </span><span style="color:#c594c5;">let</span><span> x </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">4</span><span style="color:#5fb3b3;">;
</span></td></tr><tr><td>7</td><td><span>    </span><span style="color:#c594c5;">let</span><span> y </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">4</span><span style="color:#5fb3b3;">;
</span></td></tr><tr><td>8</td><td><span>    </span><span style="color:#c594c5;">let</span><span> ret </span><span style="color:#5fb3b3;">= </span><span style="color:#6699cc;">max</span><span style="color:#5fb3b3;">(</span><span>x</span><span style="color:#5fb3b3;">,</span><span> y</span><span style="color:#5fb3b3;">);
</span></td></tr><tr><td>9</td><td><span>    assert!</span><span style="color:#5fb3b3;">(</span><span>ret </span><span style="color:#5fb3b3;">== </span><span style="color:#f99157;">4</span><span style="color:#5fb3b3;">);
</span></td></tr><tr><td>10</td><td><span style="color:#5fb3b3;">}
</span></td></tr><tr><td>11</td><td><span>
</span></td></tr><tr><td>12</td><td><span style="color:#c594c5;">fn </span><span style="color:#6699cc;">main</span><span style="color:#5fb3b3;">() {
</span></td></tr><tr><td>13</td><td><span>    </span><span style="color:#6699cc;">max_test_1</span><span style="color:#5fb3b3;">();
</span></td></tr><tr><td>14</td><td><span>    println!</span><span style="color:#5fb3b3;">(&quot;</span><span style="color:#99c794;">success</span><span style="color:#5fb3b3;">&quot;);
</span></td></tr><tr><td>15</td><td><span style="color:#5fb3b3;">}
</span></td></tr></tbody></table></code></pre>
<p>I'm keeping things extremely simple here, just writing a simple test. We have a max function, we call it with certain arguments, and check that the result is the one we expect. If we run this program, it passes. We wrote a test, it passes, we're happy.</p>
<p>You may have already spotted the problem here. Two problems, in fact: there's a bug, but also that the test case I wrote was insufficient. It was testing a very specific case and didn't catch the &quot;edge&quot; case. You could go and write another test and run it, and now finally, we get the test failing because we swapped DNA over here.</p>
<pre data-linenos data-lang="rust" style="background-color:#2b2c2f;color:#cccece;" class="language-rust "><code class="language-rust" data-lang="rust"><table><tbody><tr><td>1</td><td><span style="color:#c594c5;">fn </span><span style="color:#6699cc;">max_test_2</span><span style="color:#5fb3b3;">() {
</span></td></tr><tr><td>2</td><td><span>    </span><span style="color:#c594c5;">let</span><span> x </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">4</span><span style="color:#5fb3b3;">;
</span></td></tr><tr><td>3</td><td><span>    </span><span style="color:#c594c5;">let</span><span> y </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">3</span><span style="color:#5fb3b3;">;
</span></td></tr><tr><td>4</td><td><span>    </span><span style="color:#c594c5;">let</span><span> ret </span><span style="color:#5fb3b3;">= </span><span style="color:#6699cc;">max</span><span style="color:#5fb3b3;">(</span><span>x</span><span style="color:#5fb3b3;">,</span><span> y</span><span style="color:#5fb3b3;">);
</span></td></tr><tr><td>5</td><td><span>    assert_eq!</span><span style="color:#5fb3b3;">(</span><span>ret</span><span style="color:#5fb3b3;">, </span><span style="color:#f99157;">4</span><span style="color:#5fb3b3;">);
</span></td></tr><tr><td>6</td><td><span style="color:#5fb3b3;">}
</span></td></tr><tr><td>7</td><td><span>
</span></td></tr><tr><td>8</td><td><span style="color:#c594c5;">fn </span><span style="color:#6699cc;">main</span><span style="color:#5fb3b3;">() {
</span></td></tr><tr><td>9</td><td><span>    </span><span style="color:#6699cc;">max_test_1</span><span style="color:#5fb3b3;">();
</span></td></tr><tr><td>10</td><td><span>    </span><span style="color:#6699cc;">max_test_2</span><span style="color:#5fb3b3;">();
</span></td></tr><tr><td>11</td><td><span>    println!</span><span style="color:#5fb3b3;">(&quot;</span><span style="color:#99c794;">success</span><span style="color:#5fb3b3;">&quot;);
</span></td></tr><tr><td>12</td><td><span style="color:#5fb3b3;">}
</span></td></tr></tbody></table></code></pre>
<p>That's how test-based development works, and it can work well. One needs to pay attention that the tests they write will catch edge cases or unexpected behavior. Let's see if we can do better: the way I'm writing this next test is a bit different. Instead of writing the return value that we expect exactly, I'm stating the property I want the return value to have.</p>
<pre data-linenos data-lang="rust" style="background-color:#2b2c2f;color:#cccece;" class="language-rust "><code class="language-rust" data-lang="rust"><table><tbody><tr><td>1</td><td><span style="color:#c594c5;">fn </span><span style="color:#6699cc;">max_test_3</span><span style="color:#5fb3b3;">() {
</span></td></tr><tr><td>2</td><td><span>    </span><span style="color:#c594c5;">let</span><span> x </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">4</span><span style="color:#5fb3b3;">;
</span></td></tr><tr><td>3</td><td><span>    </span><span style="color:#c594c5;">let</span><span> y </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">3</span><span style="color:#5fb3b3;">;
</span></td></tr><tr><td>4</td><td><span>    </span><span style="color:#c594c5;">let</span><span> ret </span><span style="color:#5fb3b3;">= </span><span style="color:#6699cc;">max</span><span style="color:#5fb3b3;">(</span><span>x</span><span style="color:#5fb3b3;">,</span><span> y</span><span style="color:#5fb3b3;">);
</span></td></tr><tr><td>5</td><td><span>    assert!</span><span style="color:#5fb3b3;">(</span><span>ret </span><span style="color:#5fb3b3;">==</span><span> x </span><span style="color:#5fb3b3;">||</span><span> ret </span><span style="color:#5fb3b3;">==</span><span> y</span><span style="color:#5fb3b3;">);
</span></td></tr><tr><td>6</td><td><span>    assert!</span><span style="color:#5fb3b3;">(</span><span>ret </span><span style="color:#5fb3b3;">&gt;=</span><span> x </span><span style="color:#5fb3b3;">&amp;&amp;</span><span> ret </span><span style="color:#5fb3b3;">&gt;=</span><span> y</span><span style="color:#5fb3b3;">);
</span></td></tr><tr><td>7</td><td><span style="color:#5fb3b3;">}
</span></td></tr><tr><td>8</td><td><span>
</span></td></tr><tr><td>9</td><td><span style="color:#c594c5;">fn </span><span style="color:#6699cc;">main</span><span style="color:#5fb3b3;">() {
</span></td></tr><tr><td>10</td><td><span>    </span><span style="color:#6699cc;">max_test_3</span><span style="color:#5fb3b3;">();
</span></td></tr><tr><td>11</td><td><span>    println!</span><span style="color:#5fb3b3;">(&quot;</span><span style="color:#99c794;">success</span><span style="color:#5fb3b3;">&quot;);
</span></td></tr><tr><td>12</td><td><span style="color:#5fb3b3;">}
</span></td></tr></tbody></table></code></pre>
<p>I'm saying the return value here should be either of the two arguments and should be the greater one of the two. In this test we would fail the assertion on line 6, because <code>max</code> is not returning the maximum.</p>
<p>When writing tests you have to write a test case for each point in the input space of this function, but you never really know that you've caught all the possible issues and bugs because you can't possibly test for all the cases.</p>
<h3 id="from-tests-to-formal-specifications">From tests to formal specifications</h3>
<p>To use our tool, Verus, we need to re-organize the code a bit.</p>
<pre data-linenos data-lang="verus" style="background-color:#2b2c2f;color:#cccece;" class="language-verus "><code class="language-verus" data-lang="verus"><table><tbody><tr><td>1</td><td><span style="color:#c594c5;">use </span><span>vstd</span><span style="color:#5fb3b3;">::</span><span>prelude</span><span style="color:#5fb3b3;">::*;
</span></td></tr><tr><td>2</td><td><span>verus! </span><span style="color:#5fb3b3;">{
</span></td></tr><tr><td>3</td><td><span>
</span></td></tr><tr><td>4</td><td><span style="color:#c594c5;">fn </span><span style="color:#6699cc;">max</span><span style="color:#5fb3b3;">(</span><span style="color:#f99157;">a</span><span style="color:#5fb3b3;">: </span><span style="color:#c594c5;">u64</span><span>, </span><span style="color:#f99157;">b</span><span style="color:#5fb3b3;">: </span><span style="color:#c594c5;">u64</span><span style="color:#5fb3b3;">) -&gt; </span><span style="color:#c594c5;">u64 </span><span style="color:#5fb3b3;">{
</span></td></tr><tr><td>5</td><td><span>    </span><span style="color:#c594c5;">if</span><span> a </span><span style="color:#5fb3b3;">&gt;=</span><span> b </span><span style="color:#5fb3b3;">{</span><span> a </span><span style="color:#5fb3b3;">} </span><span style="color:#c594c5;">else </span><span style="color:#5fb3b3;">{</span><span> b </span><span style="color:#5fb3b3;">}
</span></td></tr><tr><td>6</td><td><span style="color:#5fb3b3;">}
</span></td></tr><tr><td>7</td><td><span>
</span></td></tr><tr><td>8</td><td><span style="color:#c594c5;">fn </span><span style="color:#6699cc;">max_test</span><span style="color:#5fb3b3;">() {
</span></td></tr><tr><td>9</td><td><span>    </span><span style="color:#c594c5;">let</span><span> x </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">4</span><span style="color:#5fb3b3;">;
</span></td></tr><tr><td>10</td><td><span>    </span><span style="color:#c594c5;">let</span><span> y </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">3</span><span style="color:#5fb3b3;">;
</span></td></tr><tr><td>11</td><td><span>    </span><span style="color:#c594c5;">let</span><span> ret </span><span style="color:#5fb3b3;">= </span><span style="color:#6699cc;">max</span><span style="color:#5fb3b3;">(</span><span>x</span><span style="color:#5fb3b3;">,</span><span> y</span><span style="color:#5fb3b3;">);
</span></td></tr><tr><td>12</td><td><span>    </span><span style="color:#6699cc;">assert</span><span style="color:#5fb3b3;">(</span><span>ret </span><span style="color:#5fb3b3;">==</span><span> x </span><span style="color:#5fb3b3;">||</span><span> ret </span><span style="color:#5fb3b3;">==</span><span> y</span><span style="color:#5fb3b3;">);
</span></td></tr><tr><td>13</td><td><span>    </span><span style="color:#6699cc;">assert</span><span style="color:#5fb3b3;">(</span><span>ret </span><span style="color:#5fb3b3;">&gt;=</span><span> x </span><span style="color:#5fb3b3;">&amp;&amp;</span><span> ret </span><span style="color:#5fb3b3;">&gt;=</span><span> y</span><span style="color:#5fb3b3;">);
</span></td></tr><tr><td>14</td><td><span style="color:#5fb3b3;">}
</span></td></tr><tr><td>15</td><td><span>
</span></td></tr><tr><td>16</td><td><span style="color:#5fb3b3;">} </span><span style="color:#5f6364;">// verus!
</span></td></tr></tbody></table></code></pre>
<p>I took the max function from before, fixed the issue, and then wrote Verus assertions as part of the <code>max_test</code> functions (on lines 12 and 13): these look different from regular rust assertion but I'm keeping the property that we wanted: the return value is either of the inputs and it is greater or equal to both.</p>
<pre class="ansi-html"><code><span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#ffc4bd;">error</span><span style="font-weight:bold;color:#8e8e8e;">: assertion failed</span>
  <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#c1e3fe;">--&gt; </span>/Users/andreal1/Demo/A2-program-0.rs:13:12
   <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#c1e3fe;">|</span>
<span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#c1e3fe;">13</span> <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#c1e3fe;">|</span>     assert(ret == x || ret == y);
   <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#c1e3fe;">| </span>           <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#ffc4bd;">^^^^^^^^^^^^^^^^^^^^</span> <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#ffc4bd;">assertion failed</span>

<span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#ffc4bd;">error</span><span style="font-weight:bold;color:#8e8e8e;">: assertion failed</span>
  <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#c1e3fe;">--&gt; </span>/Users/andreal1/Demo/A2-program-0.rs:14:12
   <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#c1e3fe;">|</span>
<span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#c1e3fe;">14</span> <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#c1e3fe;">|</span>     assert(ret &gt;= x &amp;&amp; ret &gt;= y);
   <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#c1e3fe;">| </span>           <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#ffc4bd;">^^^^^^^^^^^^^^^^^^^^</span> <span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#ffc4bd;">assertion failed</span>

<span style="font-weight:bold;color:#8e8e8e;"></span><span style="font-weight:bold;color:#ffc4bd;">error</span><span style="font-weight:bold;color:#8e8e8e;">: aborting due to 2 previous errors</span>

verification results:: 1 verified, 1 errors
</code></pre>
<p>The error message we get from Verus is different; it's not a panic. We actually never run the code here. What Verus does is it statically checks every possible way that the program could run and checks whether these assertions are true in every possible case.</p>
<p><i>...</i></p>

    </div>

    
    <div class="article-info">
        
        <div class="article-date">20 February 2024</div>
        
        <div class="article-taxonomies">
            
                Written by
                <ul class="article-authors">
                    
                    <li><a href="https://verus-lang.github.io/blog/authors/andrea-lattuada/">Andrea Lattuada</a></li>
                    
                </ul>
            
            
            
        </div>
    </div>

</article>


        </main>
        <footer>
            <p class="powered-by-footer">
                Powered by <a target="_blank" href="https://getzola.org/">Zola</a>, Theme <a target="_blank" href="https://github.com/zbrox/anpu-zola-theme">Anpu</a> (customized).
            </p>
            <p>
                
                
            </p>
        </footer>
    </div>
  </div>

  <div class="dark-mode-buttons">
  <button class="dark-mode-button" id="dark-mode-on">
    <img
      src="https://verus-lang.github.io/blog/dark_mode.svg"
      width="24"
      height="24"
      alt="Dark mode"
      aria-label="dark mode toggle"
      title="Dark mode"
    />
  </button>
  <button class="dark-mode-button" id="dark-mode-off">
    <img
      src="https://verus-lang.github.io/blog/light_mode.svg "
      width="24"
      height="24"
      alt="Light mode"
      aria-label="light mode toggle"
      title="Light mode"
      style="filter: invert(1);"
    />
  </button>
</div>
<script>
  const cls = document.body.classList;
  const getSessionTheme = sessionStorage.getItem("theme");
  if (getSessionTheme === "dark") {
    cls.toggle("dark-mode", true);
  } else if (getSessionTheme === "light") {
    cls.toggle("dark-mode", false);
  } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
    cls.toggle("dark-mode", true);
  }
  document
    .getElementById("dark-mode-on")
    .addEventListener("click", function (e) {
      cls.toggle("dark-mode", true);
      sessionStorage.setItem("theme", "dark");
    });
  document
    .getElementById("dark-mode-off")
    .addEventListener("click", function (e) {
      cls.toggle("dark-mode", false);
      sessionStorage.setItem("theme", "light");
    });
</script>
<noscript>
  <style>
    .dark-mode-buttons {
      display: none;
    }
  </style>
</noscript>

    
</body>
</html>
